import{d as e,r as a,j as t,k as l,c as r,a as o,w as s,f as i,e as n,h as c,i as u,m as d,t as m,o as v,u as p}from"./index-DOZqpDgu.js";import{a as f}from"./api-O7hkGn9P.js";const g={class:"d-flex gap-1"},_=e({__name:"TasksList",props:{searchTerm:{}},setup(e,{expose:p}){const _=e,b=a([]),y=a(!1),k=a(null),h=a(null),w=a(null),C=t(()=>"admin"===w.value?.rol),E=[{title:"Título",value:"titulo"},{title:"Descripción",value:"descripcion"},{title:"Estado",value:"estado"},{title:"Usuario Asignado",value:"usuario_nombre"},{title:"Fecha Vencimiento",value:"fecha_vencimiento"},{title:"Fecha Creación",value:"created_at"},{title:"Acciones",value:"actions",sortable:!1}],x=async()=>{y.value=!0;try{console.log("🔍 DEBUG TasksList - Cargando tareas desde API...");const e=await f.get("/tareas");console.log("🔍 DEBUG TasksList - Respuesta de tareas:",e),console.log("🔍 DEBUG TasksList - Datos recibidos:",e.data);let a=[];const t=e.data;Array.isArray(t)?a=t.map(e=>({...e,usuario_nombre:e.usuario?.nombre||`Usuario ${e.usuario_id}`||"Sin asignar"})):t&&Array.isArray(t.data)?a=t.data.map(e=>({...e,usuario_nombre:e.usuario?.nombre||`Usuario ${e.usuario_id}`||"Sin asignar"})):(console.warn("⚠️ TasksList - Formato de tareas no reconocido:",t),a=[]),console.log("🎯 TasksList - Tareas procesadas:",a),b.value=a}catch(e){console.error("Error al cargar tareas:",e),b.value=[]}finally{y.value=!1}};l(()=>{const e=localStorage.getItem("user");w.value=e?JSON.parse(e):null,x()});const L=e=>{if(!e)return"-";return new Date(e).toLocaleDateString("es-ES",{year:"numeric",month:"2-digit",day:"2-digit"})},T=e=>{switch(e){case"pendiente":return"orange";case"en_progreso":return"blue";case"completada":return"green";default:return"grey"}},S=t(()=>{const e=(_.searchTerm||"").toLowerCase().trim(),a=Array.isArray(b.value)?b.value:[];return e?a.filter(a=>a.titulo.toLowerCase().includes(e)||a.descripcion.toLowerCase().includes(e)||a.estado.toLowerCase().includes(e)||(a.usuario_nombre||"").toLowerCase().includes(e)):a}),U=async(e,a)=>{if(C.value){h.value=e.id;try{await f.put(`/tareas/${e.id}`,{...e,estado:a});const t=b.value.findIndex(a=>a.id===e.id);-1!==t&&(b.value[t].estado=a),console.log(`Estado de tarea "${e.titulo}" cambiado a: ${a}`)}catch(t){console.error("Error al cambiar estado:",t);alert(t?.response?.data?.message||"Error al cambiar el estado de la tarea")}finally{h.value=null}}else alert("No tienes permisos para cambiar el estado de las tareas")},A=async e=>{k.value=e;try{await f.delete(`/tareas/${e}`),b.value=b.value.filter(a=>a.id!==e),alert("Tarea eliminada exitosamente")}catch(a){console.error("Error al eliminar tarea:",a);alert(a?.response?.data?.message||"Error al eliminar la tarea")}finally{k.value=null}};return p({fetchTasks:x}),(e,a)=>{const t=o("v-chip"),l=o("v-icon"),p=o("v-btn"),f=o("v-list-item-title"),_=o("v-list-item"),b=o("v-list"),w=o("v-menu"),x=o("v-data-table");return v(),r(x,{items:S.value,headers:E,loading:y.value,class:"elevation-1"},{"item.estado":s(({item:e})=>[n(t,{color:T(e.estado),size:"small",variant:"flat"},{default:s(()=>[u(m(e.estado),1)]),_:2},1032,["color"])]),"item.fecha_vencimiento":s(({item:e})=>[u(m(L(e.fecha_vencimiento)),1)]),"item.created_at":s(({item:e})=>[u(m(L(e.created_at)),1)]),"item.actions":s(({item:e})=>[i("div",g,[n(p,{size:"small",color:"primary",variant:"outlined",onClick:a=>{return t=e.id,void(window.location.href=`/tareas/${t}/editar`);var t}},{default:s(()=>[n(l,{size:"small"},{default:s(()=>[...a[0]||(a[0]=[u("mdi-pencil",-1)])]),_:1})]),_:2},1032,["onClick"]),C.value?(v(),r(w,{key:0},{activator:s(({props:t})=>[n(p,d({size:"small",color:"info",variant:"outlined"},t,{loading:h.value===e.id}),{default:s(()=>[n(l,{size:"small"},{default:s(()=>[...a[1]||(a[1]=[u("mdi-swap-horizontal",-1)])]),_:1})]),_:2},1040,["loading"])]),default:s(()=>[n(b,null,{default:s(()=>[n(_,{onClick:a=>U(e,"pendiente")},{default:s(()=>[n(f,null,{default:s(()=>[...a[2]||(a[2]=[u("Pendiente",-1)])]),_:1})]),_:2},1032,["onClick"]),n(_,{onClick:a=>U(e,"en_progreso")},{default:s(()=>[n(f,null,{default:s(()=>[...a[3]||(a[3]=[u("En Progreso",-1)])]),_:1})]),_:2},1032,["onClick"]),n(_,{onClick:a=>U(e,"completada")},{default:s(()=>[n(f,null,{default:s(()=>[...a[4]||(a[4]=[u("Completada",-1)])]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)):c("",!0),C.value?(v(),r(p,{key:1,size:"small",color:"error",variant:"outlined",onClick:a=>(async e=>{if(!C.value)return void alert("No tienes permisos para eliminar tareas");confirm(`¿Estás seguro de que deseas eliminar la tarea "${e.titulo}"?\n\nEsta acción no se puede deshacer.`)&&await A(e.id)})(e),loading:k.value===e.id},{default:s(()=>[n(l,{size:"small"},{default:s(()=>[...a[5]||(a[5]=[u("mdi-delete",-1)])]),_:1})]),_:2},1032,["onClick","loading"])):c("",!0)])]),"no-data":s(()=>[...a[6]||(a[6]=[i("div",{class:"pa-6 text-center"},"No hay tareas para mostrar.",-1)])]),_:1},8,["items","loading"])}}}),b={class:"text-caption"},y=e({__name:"TasksView",setup(e){const t=p(),c=a(""),d=a(!1),g=a(),y=a(null);l(()=>{const e=localStorage.getItem("user");y.value=e?JSON.parse(e):null});const k=()=>t.push("/tareas/nueva"),h=()=>t.push("/usuarios"),w=async()=>{try{await f.post("/logout")}catch(e){console.warn("Error al hacer logout en el servidor:",e)}finally{localStorage.removeItem("token"),localStorage.removeItem("user"),t.push("/login")}},C=async()=>{d.value=!0;try{console.log("Descargando reporte Excel...");const e=await f.get("/tareas/reporte-excel",{responseType:"blob"}),a=window.URL.createObjectURL(new Blob([e.data])),t=document.createElement("a");t.href=a,t.setAttribute("download",`reporte-tareas-${(new Date).toISOString().substring(0,10)}.xlsx`),document.body.appendChild(t),t.click(),t.remove(),window.URL.revokeObjectURL(a),console.log("Reporte Excel descargado exitosamente")}catch(e){console.error("Error al descargar reporte:",e),alert("Error al descargar el reporte Excel. Por favor, intente de nuevo.")}finally{d.value=!1}};return(e,a)=>{const t=o("v-btn"),l=o("v-text-field"),p=o("v-icon"),f=o("v-divider"),E=o("v-card"),x=o("v-col"),L=o("v-row"),T=o("v-container");return v(),r(T,{fluid:""},{default:s(()=>[n(L,null,{default:s(()=>[n(x,{cols:"12",md:"3"},{default:s(()=>[n(E,{class:"pa-4"},{default:s(()=>[a[7]||(a[7]=i("div",{class:"text-subtitle-1 mb-2"},"Acciones",-1)),n(t,{block:"",color:"primary",class:"mb-3",onClick:k},{default:s(()=>[...a[1]||(a[1]=[u(" Crear Tarea ",-1)])]),_:1}),n(l,{modelValue:c.value,"onUpdate:modelValue":a[0]||(a[0]=e=>c.value=e),label:"Buscar tareas","prepend-inner-icon":"mdi-magnify",density:"comfortable",clearable:"",class:"mb-4"},null,8,["modelValue"]),n(t,{block:"",color:"success",variant:"tonal",class:"mb-4",onClick:C,loading:d.value},{default:s(()=>[n(p,{left:""},{default:s(()=>[...a[2]||(a[2]=[u("mdi-download",-1)])]),_:1}),a[3]||(a[3]=u(" Descargar Reporte ",-1))]),_:1},8,["loading"]),n(t,{block:"",color:"info",variant:"tonal",class:"mb-3",onClick:h},{default:s(()=>[...a[4]||(a[4]=[u(" Ver Usuarios ",-1)])]),_:1}),n(t,{block:"",color:"error",variant:"tonal",onClick:w},{default:s(()=>[...a[5]||(a[5]=[u(" Cerrar sesión ",-1)])]),_:1}),n(f,{class:"my-4"}),i("div",b,[a[6]||(a[6]=u(" Sesión: ",-1)),i("strong",null,m(y.value?.nombre),1),u(" ("+m(y.value?.rol)+") ",1)])]),_:1})]),_:1}),n(x,{cols:"12",md:"9"},{default:s(()=>[n(E,{class:"pa-4"},{default:s(()=>[a[8]||(a[8]=i("div",{class:"text-h6 mb-4"},"Gestión de Tareas",-1)),n(_,{ref_key:"tasksListRef",ref:g,"search-term":c.value},null,8,["search-term"])]),_:1})]),_:1})]),_:1})]),_:1})}}});export{y as default};
